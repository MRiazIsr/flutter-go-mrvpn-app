# CLAUDE.md — Project Guide for Claude Code

## Project Overview

MRVPN is a Windows VPN desktop application. Two-process architecture:
- **Flutter UI** (`app/`) — `MRVPN.exe`, runs as normal user
- **Go backend** (`core/`) — `MRVPN-service.exe`, runs elevated (admin) for TUN interface

Communication: JSON-RPC over Windows named pipe `\\.\pipe\MRVPN`.

## Key Conventions

- **Language**: code and comments in English; UI supports EN/RU via `app/lib/l10n/translations.dart`
- **State management**: Riverpod (flutter_riverpod). Providers in `app/lib/providers/`
- **Navigation**: GoRouter with ShellRoute. Routes defined in `app/lib/app.dart`
- **Theme**: custom dark/light themes in `app/lib/theme/`. Brand colors: purple `#7C3AED` → pink `#EC4899`
- **Window**: frameless (`TitleBarStyle.hidden`) with custom header in `app/lib/widgets/app_header.dart`
- **Exe names**: `MRVPN.exe` (UI), `MRVPN-service.exe` (backend). Set in `app/windows/CMakeLists.txt` and `app/lib/services/backend_launcher.dart`
- **Pipe name**: `\\.\pipe\MRVPN` — must match in both `app/lib/services/ipc_service.dart` and `core/internal/ipc/server.go`
- **Service name**: `MRVPN` — Windows service registered in `core/internal/service/windows.go`

## Build Commands

```powershell
# Full build (Go + Flutter + installer)
.\scripts\build.ps1

# Flutter-only quick deploy
.\scripts\deploy.ps1

# Flutter only, skip Go
.\scripts\build.ps1 -SkipGo -SkipInstaller

# Regenerate app icon
python scripts\generate_icon.py
```

Build output: `dist/`. Build cache: `app/build/windows/` (auto-wiped by scripts).

## Architecture Details

### Flutter App (`app/lib/`)
- `main.dart` — startup, window_manager, system_tray, shutdown logic
- `app.dart` — MaterialApp.router, GoRouter, AppShell (header + sidebar + content)
- `services/ipc_service.dart` — FFI named pipe client (CreateFileW, ReadFile, WriteFile)
- `services/backend_launcher.dart` — ShellExecuteW with "runas" to launch elevated backend
- `services/vpn_service.dart` — high-level VPN API wrapping IPC calls
- `widgets/connect_button.dart` — animated connect button with organic glow effect
- `widgets/app_header.dart` — custom title bar (drag, minimize-to-tray, maximize, close, theme/lang toggles)

### Go Backend (`core/`)
- `cmd/mriaz-service/main.go` — entry point (-interactive mode or Windows service)
- `internal/ipc/server.go` — named pipe server accepting one client
- `internal/ipc/handler.go` — JSON-RPC method dispatcher (vpn.connect, vpn.disconnect, vpn.status, service.shutdown, etc.)
- `internal/vpn/engine.go` — sing-box instance lifecycle
- `internal/vpn/config.go` — generates sing-box JSON config from parsed links
- `internal/parser/` — VLESS and Hysteria2 URL parsers
- `internal/splittunnel/` — per-app routing with app icon extraction
- `internal/service/windows.go` — Windows SCM service install/uninstall/run

### Shutdown Flow
1. User clicks "Exit" in tray → `_exitApp()` in `main.dart`
2. Sends `service.shutdown` via IPC (awaited, 500ms timeout)
3. Go backend receives it → disconnects VPN → `os.Exit(0)` after 500ms
4. Flutter calls `_systemTray.destroy()` then `exit(0)`

### IPC Protocol
JSON-RPC over newline-delimited JSON on `\\.\pipe\MRVPN`:
```json
{"id":"1","method":"vpn.connect","params":{"link":"vless://..."}}
{"id":"1","result":{"serverName":"...","protocol":"vless"}}
```

Methods: `vpn.connect`, `vpn.disconnect`, `vpn.status`, `servers.ping`, `apps.list`, `split.setConfig`, `split.getConfig`, `service.shutdown`

## Important Notes

- **Elevated process**: Go backend runs as admin. Cannot be killed via `taskkill` from non-elevated Flutter app. Only `service.shutdown` IPC command works.
- **Build cache**: scripts wipe `app/build/windows/` before every build to ensure icon/RC changes are picked up.
- **Flutter package name**: remains `mriaz_vpn` in `pubspec.yaml` to avoid breaking the Flutter build system. Exe name is controlled by CMakeLists.txt `BINARY_NAME`.
- **Go module path**: `github.com/mriaz/vpn-core` — not renamed to avoid rewriting all imports.
- **Icon**: generated by `scripts/generate_icon.py` using Pillow. BMP-format ICO (not PNG) for resource compiler compatibility. Shield shape with "MR" text in brand gradient.
- **System tray icon**: `app_icon.ico` must be next to the exe at runtime. CMake install rule + build scripts handle copying.
